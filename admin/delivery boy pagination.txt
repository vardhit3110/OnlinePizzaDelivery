<?php
include '_dbconnect.php'; // Database connection

// Pagination logic
$limit = 1; // Number of Rejected Delivery Boys per page
$current_page = isset($_GET['p']) ? (int) $_GET['p'] : 1; // Changed to 'p' to match your links
if ($current_page < 1)
    $current_page = 1;

// Calculate offset
$offset = ($current_page - 1) * $limit;
// Fetch pending delivery requests
$pendingQuery = "SELECT id, delivery_boy_name, first_name, last_name, email, phone, vehicle_type FROM delivery_boys WHERE status='pending' LIMIT $limit OFFSET $offset";
$pendingResult = mysqli_query($conn, $pendingQuery);
// Get total count for pagination
$countQuery = "SELECT COUNT(*) as total FROM delivery_boys";
$countResult = $conn->query($countQuery);
$totalRequest = $countResult->fetch_assoc()['total'];
$totalPages = ceil($totalRequest / $limit);

// Ensure current page doesn't exceed total pages
if ($current_page > $totalPages && $totalPages > 0) {
    $current_page = $totalPages;
}


// Pagination logic
$limit = 1; // Number of Rejected Delivery Boys per page
$current_page = isset($_GET['p']) ? (int) $_GET['p'] : 1; // Changed to 'p' to match your links
if ($current_page < 1)
    $current_page = 1;

// Calculate offset
$offset = ($current_page - 1) * $limit;
// Fetch approved delivery boys
$approvedQuery = "SELECT id, delivery_boy_name, first_name, last_name, email, phone, vehicle_type FROM delivery_boys WHERE status='approved' LIMIT $limit OFFSET $offset";
$approvedResult = mysqli_query($conn, $approvedQuery);
// Get total count for pagination
$countQuery = "SELECT COUNT(*) as total FROM delivery_boys";
$countResult = $conn->query($countQuery);
$totalRequest = $countResult->fetch_assoc()['total'];
$totalPages = ceil($totalRequest / $limit);

// Ensure current page doesn't exceed total pages
if ($current_page > $totalPages && $totalPages > 0) {
    $current_page = $totalPages;
}
// Fetch rejected delivery boys


// Pagination logic
$limit = 1; // Number of Rejected Delivery Boys per page
$current_page = isset($_GET['p']) ? (int) $_GET['p'] : 1; // Changed to 'p' to match your links
if ($current_page < 1)
    $current_page = 1;

// Calculate offset
$offset = ($current_page - 1) * $limit;
$rejectedQuery = "SELECT id, delivery_boy_name, first_name, last_name, email, phone, vehicle_type FROM delivery_boys WHERE status='rejected' LIMIT $limit OFFSET $offset";
$rejectedResult = mysqli_query($conn, $rejectedQuery);
// Get total count for pagination
$countQuery = "SELECT COUNT(*) as total FROM delivery_boys";
$countResult = $conn->query($countQuery);
$totalRequest = $countResult->fetch_assoc()['total'];
$totalPages = ceil($totalRequest / $limit);

// Ensure current page doesn't exceed total pages
if ($current_page > $totalPages && $totalPages > 0) {
    $current_page = $totalPages;
}


$alertMessage = "";
if (isset($_GET['msg'])) {
    $msg = htmlspecialchars($_GET['msg']); // Prevent XSS attacks
    if ($msg == "approved") {
        $alertMessage = "Delivery request approved successfully!";
    } elseif ($msg == "rejected") {
        $alertMessage = "Delivery request rejected!";
    } elseif ($msg == "removed") {
        $alertMessage = "Delivery boy removed successfully!";
    } elseif ($msg == "error") {
        $alertMessage = "Error removing delivery boy!";
    }
}
?>

<!-- JavaScript for Alert Message -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let message = "<?php echo $alertMessage; ?>";
        if (message) {
            alert(message);
            window.location.href = "index.php?page=deliveryRequests";
        }
    });
</script>
<style>
    /* Pagination CSS */
    .pagination-container {
        display: flex;
        justify-content: flex-end;
        /* Align to right */
        margin: 20px 0;
    }

    .pagination {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .pagination a {
        padding: 8px 12px;
        border: 1px solid #ddd;
        color: rgb(116, 101, 179);
        text-decoration: none;
        border-radius: 3px;
        transition: all 0.3s;
    }

    .pagination span {
        padding: 8px 12px;
        border: 1px solid #ddd;
        color: rgb(0, 0, 0);
        text-decoration: none;
        border-radius: 3px;
    }

    .pagination a:hover {
        background: rgb(236, 236, 246);
    }

    .pagination .active {
        background: rgb(60, 185, 187);
        color: white;
        border-color: rgb(60, 185, 187);
    }

    .pagination .disabled {
        color: #aaa;
        border-color: #eee;
        cursor: not-allowed;
    }

    .pagination-info {
        text-align: right;
        margin-top: 10px;
        color: #666;
    }

    /* Show more page numbers */
    .pagination .page-numbers {
        display: flex;
        gap: 5px;
    }
</style>

<div class="container-fluid" id="empty" style="margin-top: 20px; padding-top: 20px;">

    <div class="row">
        <div class="card col-lg-12">
            <div class="card-body">
                <h3 class="text-center">Pending Delivery Requests</h3>
                <table class="table table-striped table-bordered col-md-12 text-center">
                    <thead style="background-color: rgb(111 202 203);">
                        <tr>
                            <th>ID</th>
                            <th>Delivery Boy Name</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Vehicle</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $count = 0;
                        while ($row = mysqli_fetch_assoc($pendingResult)) {
                            $count++;
                            echo '<tr>
                                        <td>' . htmlspecialchars($row['id']) . '</td>
                                        <td>' . htmlspecialchars($row['delivery_boy_name']) . '</td>
                                        <td>' . htmlspecialchars($row['first_name'] . ' ' . $row['last_name']) . '</td>
                                        <td>' . htmlspecialchars($row['email']) . '</td>
                                        <td>' . htmlspecialchars($row['phone']) . '</td>
                                        <td>' . htmlspecialchars($row['vehicle_type'] ? $row['vehicle_type'] : 'N/A') . '</td>
                                        <td>
                                            <a href="partials/_manageDeliveryBoy.php?id=' . urlencode($row['id']) . '&action=approve" class="btn btn-success btn-sm">Accept</a>
                                            <a href="partials/_manageDeliveryBoy.php?id=' . urlencode($row['id']) . '&action=reject" class="btn btn-danger btn-sm">Reject</a>
                                        </td>
                                    </tr>';
                        }
                        if ($count == 0) {
                            echo '<tr><td colspan="7" class="text-center"><div class="alert alert-info">No pending delivery requests!</div></td></tr>';
                        }
                        ?>
                    </tbody>
                </table>

                <!-- Pagination -->
                <?php if ($totalPages > 1): ?>
                    <div class="pagination-container">
                        <div>
                            <div class="pagination">
                                <!-- Previous Button -->
                                <?php if ($current_page <= 1): ?>
                                    <span class="disabled">« Previous</span>
                                <?php else: ?>
                                    <a href="index.php?page=deliveryRequests&p=<?php echo $current_page - 1; ?>">«
                                        Previous</a>
                                <?php endif; ?>

                                <!-- Page Numbers -->
                                <div class="page-numbers">
                                    <?php
                                    // Show more page numbers (current page ± 3)
                                    $start = max(1, $current_page - 1);
                                    $end = min($totalPages, $current_page + 1);

                                    // Always show first page
                                    if ($start > 1) {
                                        echo '<a href="index.php?page=deliveryRequests&p=1">1</a>';
                                        if ($start > 2)
                                            echo '<span>...</span>';
                                    }

                                    // Show page numbers in range
                                    for ($i = $start; $i <= $end; $i++) {
                                        if ($i == $current_page) {
                                            echo '<a href="index.php?page=deliveryRequests&p=' . $i . '" class="active">' . $i . '</a>';
                                        } else {
                                            echo '<a href="index.php?page=deliveryRequests&p=' . $i . '">' . $i . '</a>';
                                        }
                                    }

                                    // Always show last page
                                    if ($end < $totalPages) {
                                        if ($end < $totalPages - 1)
                                            echo '<span>...</span>';
                                        echo '<a href="index.php?page=deliveryRequests&p=' . $totalPages . '">' . $totalPages . '</a>';
                                    }
                                    ?>
                                </div>

                                <!-- Next Button -->
                                <?php if ($current_page >= $totalPages): ?>
                                    <span class="disabled">Next »</span>
                                <?php else: ?>
                                    <a href="index.php?page=deliveryRequests&p=<?php
                                    echo $current_page + 1;
                                    ?>">Next »</a>
                                <?php endif; ?>
                            </div>

                            <div class="pagination-info">
                                Showing <?php echo (($current_page - 1) * $limit + 1); ?> to
                                <?php echo min($current_page * $limit, $totalRequest); ?> of
                                <?php echo $totalRequest; ?> Reject Delivery Boys
                            </div>
                        </div>
                    </div>
                <?php endif; ?>

            </div>
        </div>
    </div>

    <!-- Approved Delivery Boys Section -->
    <div class="row mt-5">
        <div class="card col-lg-12">
            <div class="card-body">
                <h3 class="text-center">Approved Delivery Boys</h3>
                <table class="table table-striped table-bordered col-md-12 text-center">
                    <thead style="background-color: rgb(111 202 203);">
                        <tr>
                            <th>ID</th>
                            <th>Delivery Boy Name</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Vehicle</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $count = 0;
                        while ($row = mysqli_fetch_assoc($approvedResult)) {
                            $count++;
                            echo '<tr>
                                        <td>' . htmlspecialchars($row['id']) . '</td>
                                        <td>' . htmlspecialchars($row['delivery_boy_name']) . '</td>
                                        <td>' . htmlspecialchars($row['first_name'] . ' ' . $row['last_name']) . '</td>
                                        <td>' . htmlspecialchars($row['email']) . '</td>
                                        <td>' . htmlspecialchars($row['phone']) . '</td>
                                        <td>' . htmlspecialchars($row['vehicle_type'] ? $row['vehicle_type'] : 'N/A') . '</td>
                                        <td>
                                            <a href="partials/_manageDeliveryBoy.php?id=' . urlencode($row['id']) . '&action=remove" class="btn btn-warning btn-sm">Remove</a>
                                        </td>
                                    </tr>';
                        }
                        if ($count == 0) {
                            echo '<tr><td colspan="7" class="text-center"><div class="alert alert-info">No approved delivery boys yet!</div></td></tr>';
                        }
                        ?>
                    </tbody>
                </table>
                <!-- Pagination -->
                <?php if ($totalPages > 1): ?>
                    <div class="pagination-container">
                        <div>
                            <div class="pagination">
                                <!-- Previous Button -->
                                <?php if ($current_page <= 1): ?>
                                    <span class="disabled">« Previous</span>
                                <?php else: ?>
                                    <a href="index.php?page=deliveryRequests&p=<?php echo $current_page - 1; ?>">«
                                        Previous</a>
                                <?php endif; ?>

                                <!-- Page Numbers -->
                                <div class="page-numbers">
                                    <?php
                                    // Show more page numbers (current page ± 3)
                                    $start = max(1, $current_page - 1);
                                    $end = min($totalPages, $current_page + 1);

                                    // Always show first page
                                    if ($start > 1) {
                                        echo '<a href="index.php?page=deliveryRequests&p=1">1</a>';
                                        if ($start > 2)
                                            echo '<span>...</span>';
                                    }

                                    // Show page numbers in range
                                    for ($i = $start; $i <= $end; $i++) {
                                        if ($i == $current_page) {
                                            echo '<a href="index.php?page=deliveryRequests&p=' . $i . '" class="active">' . $i . '</a>';
                                        } else {
                                            echo '<a href="index.php?page=deliveryRequests&p=' . $i . '">' . $i . '</a>';
                                        }
                                    }

                                    // Always show last page
                                    if ($end < $totalPages) {
                                        if ($end < $totalPages - 1)
                                            echo '<span>...</span>';
                                        echo '<a href="index.php?page=deliveryRequests&p=' . $totalPages . '">' . $totalPages . '</a>';
                                    }
                                    ?>
                                </div>

                                <!-- Next Button -->
                                <?php if ($current_page >= $totalPages): ?>
                                    <span class="disabled">Next »</span>
                                <?php else: ?>
                                    <a href="index.php?page=deliveryRequests&p=<?php
                                    echo $current_page + 1;
                                    ?>">Next »</a>
                                <?php endif; ?>
                            </div>

                            <div class="pagination-info">
                                Showing <?php echo (($current_page - 1) * $limit + 1); ?> to
                                <?php echo min($current_page * $limit, $totalRequest); ?> of
                                <?php echo $totalRequest; ?> Reject Delivery Boys
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <!-- Rejected Delivery Boys Section -->
    <div class="row mt-5">
        <div class="card col-lg-12">
            <div class="card-body">
                <h3 class="text-center">Rejected Delivery Boys</h3>
                <table class="table table-striped table-bordered col-md-12 text-center">
                    <thead style="background-color: rgb(111 202 203);">
                        <tr>
                            <th>ID</th>
                            <th>Delivery Boy Name</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Vehicle</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $count = 0;
                        while ($row = mysqli_fetch_assoc($rejectedResult)) {
                            $count++;
                            echo '<tr>
                                        <td>' . htmlspecialchars($row['id']) . '</td>
                                        <td>' . htmlspecialchars($row['delivery_boy_name']) . '</td>
                                        <td>' . htmlspecialchars($row['first_name'] . ' ' . $row['last_name']) . '</td>
                                        <td>' . htmlspecialchars($row['email']) . '</td>
                                        <td>' . htmlspecialchars($row['phone']) . '</td>
                                        <td>' . htmlspecialchars($row['vehicle_type'] ? $row['vehicle_type'] : 'N/A') . '</td>
                                    </tr>';
                        }
                        if ($count == 0) {
                            echo '<tr><td colspan="6" class="text-center"><div class="alert alert-info">No rejected delivery boys yet!</div></td></tr>';
                        }
                        ?>
                    </tbody>
                </table>

                <!-- Pagination -->
                <?php if ($totalPages > 1): ?>
                    <div class="pagination-container">
                        <div>
                            <div class="pagination">
                                <!-- Previous Button -->
                                <?php if ($current_page <= 1): ?>
                                    <span class="disabled">« Previous</span>
                                <?php else: ?>
                                    <a href="index.php?page=deliveryRequests&p=<?php echo $current_page - 1; ?>">«
                                        Previous</a>
                                <?php endif; ?>

                                <!-- Page Numbers -->
                                <div class="page-numbers">
                                    <?php
                                    // Show more page numbers (current page ± 3)
                                    $start = max(1, $current_page - 1);
                                    $end = min($totalPages, $current_page + 1);

                                    // Always show first page
                                    if ($start > 1) {
                                        echo '<a href="index.php?page=deliveryRequests&p=1">1</a>';
                                        if ($start > 2)
                                            echo '<span>...</span>';
                                    }

                                    // Show page numbers in range
                                    for ($i = $start; $i <= $end; $i++) {
                                        if ($i == $current_page) {
                                            echo '<a href="index.php?page=deliveryRequests&p=' . $i . '" class="active">' . $i . '</a>';
                                        } else {
                                            echo '<a href="index.php?page=deliveryRequests&p=' . $i . '">' . $i . '</a>';
                                        }
                                    }

                                    // Always show last page
                                    if ($end < $totalPages) {
                                        if ($end < $totalPages - 1)
                                            echo '<span>...</span>';
                                        echo '<a href="index.php?page=deliveryRequests&p=' . $totalPages . '">' . $totalPages . '</a>';
                                    }
                                    ?>
                                </div>

                                <!-- Next Button -->
                                <?php if ($current_page >= $totalPages): ?>
                                    <span class="disabled">Next »</span>
                                <?php else: ?>
                                    <a href="index.php?page=deliveryRequests&p=<?php
                                    echo $current_page + 1;
                                    ?>">Next »</a>
                                <?php endif; ?>
                            </div>

                            <div class="pagination-info">
                                Showing <?php echo (($current_page - 1) * $limit + 1); ?> to
                                <?php echo min($current_page * $limit, $totalRequest); ?> of
                                <?php echo $totalRequest; ?> Reject Delivery Boys
                            </div>
                        </div>
                    </div>
                <?php endif; ?>

            </div>
        </div>
    </div>

</div>
<br><br>